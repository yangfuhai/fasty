/*
 * fasty 1.0.0
 * The fastest javascript templating engine.
 * https://github.com/yangfuhai/fasty
 *
 * Copyright 2022, Michael <fuhai999@gmail.com>
 * Released under the MIT license.
*/
var Fasty=function(t){this.share=t&&t.share?t.share:null,this.shareDataFirst=!(!t||void 0===t.shareDataFirst)&&t.shareDataFirst,this.safelyAccess=!t||void 0===t.safelyAccess||t.safelyAccess,this.funs={}};Fasty.prototype={Tok:function(t){this.type=t,this.tag="",this.text="",this.addTokText=function(t){this.text+=t},this.isEmpty=function(){return""===this.text},this.isText=function(){return 0===t},this.isOutput=function(){return 1===t},this.arrange=function(){var t,e,r;this.isText()||(this.text=this.text.trim(),this.isOutput()&&this.safelyAccess&&(this.text=this.text.replace(/\?\./g,"$safe.").replace(/\?\(/g,"$safe(")),t=this.text.indexOf(" "),e=this.text.indexOf("("),r=this.text.indexOf("."),this.tag=t===r&&t===e&&-1===t?this.text:this.text.substring(0,this.calcMin([t,e,r])))},this.getTagAfter=function(){return this.tag?this.text.substring(this.tag.length):this.text},this.calcMin=function(t){var e,r=t[0];for(e of t)(r<=0||0<e&&e<r)&&(r=e);return r}},render:function(e,t){if(!(i=this.funs[e])){var r=this._parseTokens(e);if(!r||0===r.length)return;try{var s=this._compileTokens(r),i=new Function("$data",s);this.funs[e]=i}catch(t){return console.error("template error  >>>",t),console.error("template        >>>",e),""}}if(t=t||{},this.share)for(var a of Object.keys(this.share))!this.shareDataFirst&&t[a]||(t[a]=this.share[a]);return i(this._proxy(t,!1))},_proxy:function(t,e,r){var s=this;return this.safelyAccess?new Proxy(t,{withSafe:e,pattr:r,get:function(t,e){return"symbol"==typeof e?()=>"":e.endsWith("$safe")?(r=t[e=e.substring(0,e.length-5)])?s._proxy(r,!0,e):s._proxy(()=>{},!0,e):(r=t[e])||(this.withSafe?"":void 0);var r},apply:function(t,e,r){return Reflect.has(e,t.name)?t(r):s._proxy({},!0,this.pattr)}}):t},_parseTokens:function(t){if(t&&0!==t.trim().length){for(var e,r=[],s=0;!this._isEnd(s,t);){var i=t.charAt(s);"\n"===i||"\t"===i?s++:"{"===i&&"{"===t.charAt(s+1)?(e&&(r.push(e),e.arrange(),e=null),e="~"===t.charAt(s+2)?(s+=3,new this.Tok(2)):(s+=2,new this.Tok(1))):"}"===i&&"}"===t.charAt(s+1)?(s+=2,e&&(r.push(e),e.arrange(),e=null)):((e=e||new this.Tok(0)).addTokText(i),s++)}return e&&(e.arrange(),r.push(e)),r}},_isEnd:function(t,e){return t>=e.length},_compileComparison:function(t,e){t=t.getTagAfter().trim(),t=t.substring(1,t.length-1).trim(),t=this._appendData(this._getComparison(t),e);return t.before+t.op+t.after},_compileVars:function(e,r,s){var i=e.getTagAfter().split(","),a="";for(let t=0;t<i.length;t++){var n=i[t].split("=");if(2!==n.length)throw new Error("Variable definition error: "+e.text);var o=n[0].trim(),n=n[1].trim();this._inContextVars(r,n)||(n="$data."+n),this._pushContextVars(r,s,o),a+=o+"="+n,t===i.length-1?a+=";":a+=","}return a},_compileTokens:function(t){var e,r='var ret = "";',s={},i=0;for(e of t)if(e.isEmpty())r+="ret += ' ';";else if(e.isText())r+="ret += '"+e.text.replace(/\'/g,"\\'").replace(/\"/g,'\\"')+"';";else if(e.isOutput())this._inContextVars(s,e.tag)?r+="ret += "+e.text+";":r+="ret += $data."+e.text+";";else switch(e.tag){case"for":var a=e.text.substring(3).trim(),n=(a=a.substring(1,a.length-1).trim().replace(/\s+/g," ")).split(" ");if(3===n.length&&"of"===n[1]||"in"===n[1]){var o=n[0],h=n[2];this._inContextVars(s,h)||(h="$data."+h),this._pushContextVars(s,++i,o),r+="for ("+o+" "+n[1]+" "+h+"){";break}o=a.split(";");if(3!==o.length)break;n=new this.Tok(2),h=(n.text=o[0],n.arrange(),r=(r+="for (")+(n.tag+" "+this._compileVars(n,s,++i)),this._appendData(this._getComparison(o[1]),s)),r=(r+=h.before+h.op+h.after+";")+(o[2]+"){");break;case"if":i++,r+="if("+this._compileComparison(e,s)+"){";break;case"else":r+="}else{";break;case"elseif":r+="}else if("+this._compileComparison(e,s)+"){";break;case"end":s[i--]=null,r+="}";break;case"var":case"let":case"const":r+=e.tag+" "+this._compileVars(e,s,i);break;default:r+=e.text+";"}return r+="return ret;"},_pushContextVars:function(t,e,r){if(t[e]||(t[e]=[]),Array.isArray(r))for(var s of r)t[e].push(s);else t[e].push(r)},_inContextVars:function(t,e){if(0===e.indexOf('"')||0===e.indexOf("'"))return!0;if(!isNaN(e))return!0;var r,s=e.indexOf(".");0<(s=(e=0<s?e.substring(0,s).trim():e).indexOf("["))&&e.indexOf("]")>s&&(e=e.substring(0,s).trim());for(r of Object.values(t))if(r&&r.includes(e))return!0;return!1},_getComparison:function(t){var e;for(e of["===","!==","==","!=",">=","<=",">","<"]){var r=t.indexOf(e);if(0<r)return{before:t.substring(0,r).trim(),op:e,after:t.substring(r+e.length).trim()}}},_appendData:function(t,e){return this._inContextVars(e,t.before)||(t.before="$data."+t.before),this._inContextVars(e,t.after)||(t.after="$data."+t.after),t}};