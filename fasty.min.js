/*
 * fasty 1.0.0
 * The fastest javascript templating engine.
 * https://github.com/yangfuhai/fasty
 *
 * Copyright 2022, Michael <fuhai999@gmail.com>
 * Released under the MIT license.
*/
var Fasty=function(t){this.share=t&&t.share?t.share:null,this.shareDataFirst=!(!t||void 0===t.shareDataFirst)&&t.shareDataFirst,this.safelyAccess=!t||void 0===t.safelyAccess||t.safelyAccess,this.funs={}};Fasty.prototype={Tok:function(t){this.type=t,this.tag="",this.text="",this.addTokText=function(t){this.text+=t},this.isEmpty=function(){return""===this.text},this.isText=function(){return 0===t},this.isOutput=function(){return 1===t||2===t||3===t},this.isEscape=function(){return 2===t},this.isUnEscape=function(){return 3===t},this.arrange=function(){var t,e,r;this.isText()||(this.text=this.text.trim(),this.isOutput()&&this.safelyAccess&&(this.text=this.text.replace(/\?\./g,"$safe.").replace(/\?\(/g,"$safe(")),r=this.text.indexOf(" "),t=this.text.indexOf("("),e=this.text.indexOf("."),this.tag=r===e&&r===t&&-1===r?this.text:this.text.substring(0,this.calcMin([r,t,e])),"else"===this.tag&&(r=this.getTagAfter().trim()).startsWith("if")&&(this.tag="elseif",this.text="elseif "+r.substring(2)))},this.getTagAfter=function(){return this.tag?this.text.substring(this.tag.length):this.text},this.calcMin=function(t){var e,r=t[0];for(e of t)(r<=0||0<e&&e<r)&&(r=e);return r}},render:function(e,t){if(!(s=this.funs[e])){var r=this._parseTokens(e);if(!r||0===r.length)return;try{var i=this._compileTokens(r),s=new Function("$data",i);this.funs[e]=s}catch(t){return console.error("template error  >>>",t),console.error("template        >>>",e),""}}if((t=t||{}).$escape=function(t){return t.toString().replace(/\&/g,"&amp;").replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\'/g,"&#39;").replace(/\"/g,"&quot;")},t.$unescape=function(t){return t.toString().replace(/\&amp;/g,"&").replace(/\&lt;/g,"<").replace(/\&gt;/g,">").replace(/\&#39;/g,"'").replace(/\&quot;/g,'"')},this.share)for(var n of Object.keys(this.share))!this.shareDataFirst&&t[n]||(t[n]=this.share[n]);return s(this._proxy(t,!1))},_proxy:function(t,e,r){var i=this;return this.safelyAccess?new Proxy(t,{withSafe:e,pattr:r,get:function(t,e){return"symbol"==typeof e?()=>"":e.endsWith("$safe")?(r=t[e=e.substring(0,e.length-5)])?i._proxy(r,!0,e):i._proxy(()=>{},!0,e):(r=t[e])||(this.withSafe?"":void 0);var r},apply:function(t,e,r){return Reflect.has(e,t.name)?t(r):i._proxy({},!0,this.pattr)}}):t},_parseTokens:function(t){if(t&&0!==t.trim().length){for(var e,r=[],i=0;!this._isEnd(i,t);){var s=t.charAt(i);"\n"===s||"\t"===s?i++:"{"===s&&"{"===t.charAt(i+1)?(e&&(r.push(e),e.arrange(),e=null),e="~"===t.charAt(i+2)?(i+=3,new this.Tok(9)):"#"===t.charAt(i+2)?(i+=3,new this.Tok(2)):"!"===t.charAt(i+2)?(i+=3,new this.Tok(3)):(i+=2,new this.Tok(1))):"}"===s&&"}"===t.charAt(i+1)?(i+=2,e&&(r.push(e),e.arrange(),e=null)):((e=e||new this.Tok(0)).addTokText(s),i++)}return e&&(e.arrange(),r.push(e)),r}},_isEnd:function(t,e){return t>=e.length},_compileComparison:function(t,e){t=t.getTagAfter().trim(),t=t.substring(1,t.length-1).trim(),t=this._getComparison(t,e);return t.before+t.op+t.after},_compileVars:function(t,e,r){var i,s,n=[];for(i of t.getTagAfter().split("="))i=i.trim(),this._isArrayOrString(i)||-1===(s=i.lastIndexOf(","))?n.push(i):(n.push(i.substring(0,s)),n.push(i.substring(s+1)));if(0===n.length||n.length%2!=0)throw new Error("Variable definition error: "+t.text);var a="";for(let t=0;t<n.length;t+=2){var o=n[t],h=this._compileObjectOrMethodInvoke(e,n[t+1]);this._pushContextVars(e,r,o),a+=o+"="+h,t===n.length-2?a+=";":a+=","}return a},_isArrayOrString:function(t){return 0===t.indexOf("[")&&t.indexOf("]")===t.length-1||0===t.indexOf('"')&&t.indexOf('"')===t.length-1||0===t.indexOf("'")&&t.indexOf("'")===t.length-1},_compileTokens:function(t){var e,r='var ret = "";',i={},s=0;for(e of t)if(e.isEmpty())r+="ret += ' ';";else if(e.isText())r+="ret += '"+e.text.replace(/\'/g,"\\'").replace(/\"/g,'\\"')+"';";else if(e.isOutput())e.isEscape()?r+="ret += $data.$escape("+this._compileObjectOrMethodInvoke(i,e.text)+");":e.isUnEscape()?r+="ret += $data.$unescape("+this._compileObjectOrMethodInvoke(i,e.text)+");":r+="ret += "+this._compileObjectOrMethodInvoke(i,e.text)+";";else switch(e.tag){case"for":var n=e.text.substring(3).trim(),a=(n=n.substring(1,n.length-1).trim().replace(/\s+/g," ")).split(" ");if(3===a.length&&"of"===a[1]||"in"===a[1]){var o=a[0],h=this._compileObjectOrMethodInvoke(i,a[2]);this._pushContextVars(i,++s,o),r+="for ("+o+" "+a[1]+" "+h+"){";break}if(4===a.length&&"of"===a[2]||"in"===a[2]){o=a[1],h=this._compileObjectOrMethodInvoke(i,a[3]);this._pushContextVars(i,++s,o),r+="for ("+a[0]+" "+o+" "+a[2]+" "+h+"){";break}a=n.split(";");if(3!==a.length)break;n=new this.Tok(9),n=(n.text=a[0],n.arrange(),r=(r+="for (")+(n.tag+" "+this._compileVars(n,i,++s)),this._getComparison(a[1],i)),r=(r+=n.before+n.op+n.after+";")+(a[2]+"){");break;case"if":s++,r+="if("+this._compileComparison(e,i)+"){";break;case"else":r+="}else{";break;case"elseif":r+="}else if("+this._compileComparison(e,i)+"){";break;case"end":i[s--]=null,r+="}";break;case"var":case"let":case"const":r+=e.tag+" "+this._compileVars(e,i,s);break;default:r+=e.text+";"}return r+="return ret;"},_pushContextVars:function(t,e,r){if(t[e]||(t[e]=[]),Array.isArray(r))for(var i of r)t[e].push(i);else t[e].push(r)},_compileObjectOrMethodInvoke:function(t,e){return this._compileMethodInvoke(t,e,!0)},_compileMethodInvoke:function(e,t,r){var i=(t=t.trim()).indexOf("."),s=t.indexOf("("),n=t.indexOf(")");if(!(s<n&&0<s)){if(r){if(0===t.indexOf("[")&&0<t.indexOf("]")){var a=t.substring(1,t.indexOf("]")).split(","),o="[";for(let t=0;t<a.length;t++)o+=this._compileObjectOrMethodInvoke(e,a[t],!0),t!==a.length-1?o+=",":o+="]";t=o+t.substring(t.indexOf("]")+1)}return this._inContextVars(e,t)?t:"$data."+t}return t}var i=-1!==i&&i<s?i:s,h=t.substring(0,i),f=(h=r&&!this._inContextVars(e,h)?"$data."+h:h)+t.substring(i,s)+"(",c=t.substring(s+1,n).split(",");for(let t=0;t<c.length;t++){var u=c[t].trim();f+=u=this._inContextVars(e,u)?u:"$data."+u,t!==c.length-1&&(f+=",")}return f+=")",n+1===t.length?f:f+this._compileMethodInvoke(e,t.substring(n+1),!1)},_inContextVars:function(t,e){if(!isNaN(e))return!0;if(0===e.indexOf('"')||0===e.indexOf("'"))return!0;if(0===e.indexOf("[")&&0<e.indexOf("]"))return!0;var r,i=e.indexOf(".");0<(i=(e=0<i?e.substring(0,i).trim():e).indexOf("["))&&e.indexOf("]")>i&&(e=e.substring(0,i).trim());for(r of Object.values(t))if(r&&r.includes(e))return!0;return-1<["$data","Object","Number","String","Boolean","Array","Math","Date"].indexOf(e)||"undefined"!=typeof window&&window[e]},_getComparison:function(t,e){var r;for(r of["===","!==","==","!=",">=","<=",">","<"]){var i=t.indexOf(r);if(0<i)return{before:this._compileObjectOrMethodInvoke(e,t.substring(0,i)),op:r,after:this._compileObjectOrMethodInvoke(e,t.substring(i+r.length))}}}};